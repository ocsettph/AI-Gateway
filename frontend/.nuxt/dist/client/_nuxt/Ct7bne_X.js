import{e as M,r as g,f as L,g as j,h as I,c as i,a as t,p as S,b as H,w as O,k as p,q as b,v as R,F as E,l as N,t as r,d as y,n as k,K as z,_ as F,o as n,s as C,m as f}from"#entry";const q={class:"min-h-screen bg-transparent dark:bg-transparent py-8"},G={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"},J={class:"mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"},Q={class:"bg-white dark:bg-gray-800 rounded-lg shadow p-4 md:p-6 mb-6"},W={class:"grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4"},X=["value"],Y={class:"bg-white dark:bg-gray-800 rounded-lg shadow"},Z={class:"px-4 md:px-6 py-3 md:py-4 border-b border-gray-200 dark:border-gray-700"},tt={class:"text-base md:text-lg font-medium text-gray-900 dark:text-white"},et={class:"md:hidden p-4 space-y-4"},st={class:"flex items-start justify-between"},at={class:"flex-1 min-w-0"},dt={class:"flex items-center gap-2 mb-1"},rt={key:0,class:"text-sm font-semibold text-gray-900 dark:text-white break-words"},ot={key:1,class:"flex items-center gap-2 flex-1"},it=["onUpdate:modelValue","onKeyup","data-key-id"],nt=["onClick"],lt=["onClick"],ut=["onClick"],ct={class:"text-xs text-gray-500 dark:text-gray-400 mt-1 font-mono"},xt=["onClick"],mt={class:"space-y-2 text-sm"},gt={class:"text-gray-900 dark:text-white break-words"},pt={class:"text-xs text-gray-500 dark:text-gray-400 break-all"},yt={class:"text-gray-900 dark:text-white"},vt={class:"text-gray-900 dark:text-white"},_t={class:"flex items-center gap-2"},bt=["onUpdate:modelValue"],ft={class:"flex flex-col gap-2 pt-2 border-t border-gray-200 dark:border-gray-600"},ht=["onClick"],wt={class:"grid grid-cols-2 gap-2"},kt=["onClick"],Ct=["onClick"],$t={class:"hidden md:block overflow-x-auto -mx-4 md:mx-0"},Vt={class:"min-w-full text-xs md:text-sm divide-y divide-gray-200 dark:divide-gray-700 text-gray-900 dark:text-gray-100"},St={class:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700 text-gray-900 dark:text-gray-100"},Et={class:"px-3 md:px-4 lg:px-6 py-3 md:py-4"},Nt={class:"flex items-center gap-2"},At={class:"flex-1 min-w-0"},Tt={key:0,class:"text-xs md:text-sm font-medium break-words"},Dt={key:1,class:"flex items-center gap-2"},Pt=["onUpdate:modelValue","onKeyup","data-key-id"],Ut=["onClick"],Kt=["onClick"],Lt=["onClick"],Bt={class:"text-xs text-gray-400 mt-1"},Mt={class:"px-3 md:px-4 lg:px-6 py-3 md:py-4 text-xs md:text-sm"},jt={class:"break-words"},It={class:"text-xs text-gray-400 break-all"},Ht={class:"px-3 md:px-4 lg:px-6 py-3 md:py-4 text-xs md:text-sm"},Ot={class:"px-3 md:px-4 lg:px-6 py-3 md:py-4 text-xs md:text-sm"},Rt={class:"flex items-center gap-1 md:gap-2"},zt=["onUpdate:modelValue"],Ft={class:"px-3 md:px-4 lg:px-6 py-3 md:py-4 text-xs md:text-sm"},qt={class:"px-3 md:px-4 lg:px-6 py-3 md:py-4 text-xs md:text-sm"},Gt=["onClick"],Jt={class:"px-3 md:px-4 lg:px-6 py-3 md:py-4 text-xs md:text-sm text-right"},Qt={class:"flex flex-col sm:flex-row items-end sm:items-center gap-1 md:gap-2"},Wt=["onClick"],Xt=["onClick"],Yt=["onClick"],Zt={key:0,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"},te={class:"bg-white dark:bg-neutral-800 text-gray-900 dark:text-gray-100 rounded-lg shadow-lg w-full max-w-md md:w-[520px] max-h-[90vh] overflow-y-auto p-4 md:p-6"},ee={class:"flex items-center justify-between mb-4"},se={class:"space-y-2 text-sm"},ae={class:"mt-2"},de={class:"break-all bg-gray-100 dark:bg-neutral-700 px-2 py-1 rounded"},re={class:"mt-3"},oe={class:"flex items-center justify-between mb-1"},ie={class:"text-xs"},ne={class:"w-full bg-gray-200 dark:bg-neutral-700 rounded h-2"},le={class:"grid grid-cols-2 gap-3 mt-3"},ue={class:"font-medium"},ce={class:"font-medium"},xe={class:"mt-5 flex justify-end space-x-2"},pe=M({__name:"keys",setup(me){const $=g(""),V=g(""),c=g([]),h=g(!1),o=g(null),l=g({}),A=L(()=>{if(!o.value)return 0;const a=Number((o.value._used??o.value.current_spend)||0),e=Number(o.value._credit||o.value.credit_limit||0);if(e<=0)return a>0?100:0;const u=a/e*100;return Math.min(100,Math.max(0,u))}),B=L(()=>{const a=new Set;for(const e of c.value)e.faculty&&a.add(e.faculty);return Array.from(a).sort()}),x=j().public.apiBase,v=async()=>{const a=await $fetch(`${x}/api/admin/keys`,{params:{q:$.value,department:V.value},credentials:"include"});c.value=(a.keys||[]).map(e=>({...e,_credit:Number(e.credit_limit||0)})),await Promise.all(c.value.map(async e=>{try{const u=await $fetch(`${x}/api/keys/usage`,{params:{value:e.key_value},credentials:"include"});e._used=Number(u?.total?.cost_usd||0)}catch{e._used=Number(e.current_spend||0)}}))},T=async a=>{try{await $fetch(`${x}/api/admin/keys/${a.id}`,{method:"PATCH",body:{credit_limit:a._credit,is_active:a.is_active},credentials:"include"}),await v()}catch{try{await(await f(async()=>{const{default:s}=await import("./DrhBs4VY.js");return{default:s}},[],import.meta.url)).default.fire({icon:"error",title:"บันทึกไม่สำเร็จ"})}catch{}}},D=a=>{l.value[a.id]=a.name,setTimeout(()=>{const e=document.querySelector(`input[data-key-id="${a.id}"]`);e&&e.focus()},0)},w=async a=>{const e=l.value[a.id]?.trim();if(!e||e===a.name){_(a.id);return}try{await $fetch(`${x}/api/admin/keys/${a.id}`,{method:"PATCH",body:{name:e},credentials:"include"}),a.name=e,delete l.value[a.id];try{await(await f(async()=>{const{default:s}=await import("./DrhBs4VY.js");return{default:s}},[],import.meta.url)).default.fire({icon:"success",title:"บันทึกสำเร็จ",text:"แก้ไขชื่อ API Key เรียบร้อยแล้ว"})}catch{}}catch(u){console.error("Error updating key name:",u);try{await(await f(async()=>{const{default:d}=await import("./DrhBs4VY.js");return{default:d}},[],import.meta.url)).default.fire({icon:"error",title:"เกิดข้อผิดพลาด",text:"ไม่สามารถแก้ไขชื่อ API Key ได้"})}catch{}}},_=a=>{delete l.value[a]},P=a=>{o.value={...a},h.value=!0},U=async a=>{try{if(!(await(await f(async()=>{const{default:s}=await import("./DrhBs4VY.js");return{default:s}},[],import.meta.url)).default.fire({icon:"warning",title:"ลบคีย์นี้?",showCancelButton:!0,confirmButtonText:"ลบ",cancelButtonText:"ยกเลิก"})).isConfirmed)return}catch{}try{await $fetch(`${x}/api/admin/keys/${a.id}`,{method:"DELETE",credentials:"include"}),await v()}catch{try{await(await f(async()=>{const{default:s}=await import("./DrhBs4VY.js");return{default:s}},[],import.meta.url)).default.fire({icon:"error",title:"ลบคีย์ไม่สำเร็จ"})}catch{}}},K=async a=>{try{await $fetch(`${x}/api/admin/keys/${a.id}`,{method:"PATCH",body:{is_active:!a.is_active},credentials:"include"}),await v()}catch{}};I(v);function m(a){const e=Number(a||0);return!isFinite(e)||e===0?"0.00":e>0&&e<.01?e.toFixed(4):e.toFixed(2)}return(a,e)=>{const u=F;return n(),i("div",q,[t("div",G,[t("div",J,[e[5]||(e[5]=t("div",null,[t("h1",{class:"text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white"},"จัดการ API Keys (Admin)"),t("p",{class:"mt-2 text-sm sm:text-base text-gray-600 dark:text-gray-400"},"ดูและแก้ไขเครดิต/สถานะของคีย์ทั้งหมด")],-1)),H(u,{to:"/",class:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm whitespace-nowrap text-center"},{default:O(()=>[...e[4]||(e[4]=[y("กลับ",-1)])]),_:1})]),t("div",Q,[t("div",W,[t("div",null,[e[6]||(e[6]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"},"ค้นหา (ชื่อคีย์/ผู้ใช้/อีเมล)",-1)),p(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>$.value=s),type:"text",class:"w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:text-white",placeholder:"พิมพ์คำค้น..."},null,512),[[b,$.value]])]),t("div",null,[e[8]||(e[8]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"},"กรองตามคณะ/หน่วยงาน",-1)),p(t("select",{"onUpdate:modelValue":e[1]||(e[1]=s=>V.value=s),class:"w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:text-white"},[e[7]||(e[7]=t("option",{value:""},"ทั้งหมด",-1)),(n(!0),i(E,null,N(B.value,s=>(n(),i("option",{key:s,value:s},r(s),9,X))),128))],512),[[R,V.value]])]),t("div",{class:"flex items-end"},[t("button",{onClick:v,class:"px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"},"ค้นหา")])])]),t("div",Y,[t("div",Z,[t("h3",tt,"รายการคีย์ทั้งหมด ("+r(c.value.length)+")",1)]),t("div",et,[(n(!0),i(E,null,N(c.value,s=>(n(),i("div",{key:s.id,class:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4 space-y-3"},[t("div",st,[t("div",at,[t("div",dt,[l.value[s.id]?(n(),i("div",ot,[p(t("input",{"onUpdate:modelValue":d=>l.value[s.id]=d,onKeyup:[C(d=>w(s),["enter"]),C(d=>_(s.id),["esc"])],"data-key-id":s.id,class:"flex-1 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",autofocus:""},null,40,it),[[b,l.value[s.id]]]),t("button",{onClick:d=>w(s),class:"px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 transition-colors"}," บันทึก ",8,nt),t("button",{onClick:d=>_(s.id),class:"px-2 py-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded text-xs hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors"}," ยกเลิก ",8,lt)])):(n(),i("h3",rt,r(s.name),1)),l.value[s.id]?S("",!0):(n(),i("button",{key:2,onClick:d=>D(s),class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors flex-shrink-0",title:"แก้ไขชื่อ"},[...e[9]||(e[9]=[t("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})],-1)])],8,ut))]),t("div",ct,r(s.key_value?.slice(0,16))+"…",1)]),t("button",{onClick:d=>K(s),class:k([s.is_active?"bg-green-100 text-green-800 hover:bg-green-200 dark:bg-green-900 dark:text-green-200":"bg-red-100 text-red-800 hover:bg-red-200 dark:bg-red-900 dark:text-red-200","px-2 py-1 rounded text-xs font-semibold whitespace-nowrap flex-shrink-0 ml-2"])},r(s.is_active?"Active":"Disabled"),11,xt)]),t("div",mt,[t("div",null,[e[10]||(e[10]=t("span",{class:"font-medium text-gray-700 dark:text-gray-300"},"ผู้ใช้:",-1)),t("div",gt,r(s.fullname),1),t("div",pt,r(s.email),1)]),t("div",null,[e[11]||(e[11]=t("span",{class:"font-medium text-gray-700 dark:text-gray-300"},"คณะ/หน่วยงาน:",-1)),t("span",yt,r(s.faculty||"ไม่ระบุ"),1)]),t("div",null,[e[12]||(e[12]=t("span",{class:"font-medium text-gray-700 dark:text-gray-300"},"ใช้งานแล้ว:",-1)),t("span",vt,"$"+r(m((s._used??s.current_spend)||0)),1)])]),t("div",null,[e[14]||(e[14]=t("label",{class:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1"},"เครดิต (USD)",-1)),t("div",_t,[p(t("input",{type:"number",min:"0",step:"0.01","onUpdate:modelValue":d=>s._credit=d,class:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-600 dark:text-white text-sm"},null,8,bt),[[b,s._credit,void 0,{number:!0}]]),e[13]||(e[13]=t("span",{class:"text-xs text-gray-500"},"USD",-1))])]),t("div",ft,[t("button",{onClick:d=>P(s),class:"w-full px-3 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white rounded text-gray-900 text-sm font-medium"}," รายละเอียด ",8,ht),t("div",wt,[t("button",{onClick:d=>T(s),class:"px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm font-medium"}," บันทึก ",8,kt),t("button",{onClick:d=>U(s),class:"px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-medium"}," ลบ ",8,Ct)])])]))),128))]),t("div",$t,[t("table",Vt,[e[17]||(e[17]=t("thead",{class:"bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-200"},[t("tr",null,[t("th",{class:"px-3 md:px-4 lg:px-6 py-3 text-left text-xs font-medium"},"ชื่อคีย์"),t("th",{class:"px-3 md:px-4 lg:px-6 py-3 text-left text-xs font-medium"},"ผู้ใช้"),t("th",{class:"px-3 md:px-4 lg:px-6 py-3 text-left text-xs font-medium"},"คณะ/หน่วยงาน"),t("th",{class:"px-3 md:px-4 lg:px-6 py-3 text-left text-xs font-medium"},"เครดิต"),t("th",{class:"px-3 md:px-4 lg:px-6 py-3 text-left text-xs font-medium"},"ใช้งานแล้ว"),t("th",{class:"px-3 md:px-4 lg:px-6 py-3 text-left text-xs font-medium"},"สถานะ"),t("th",{class:"px-3 md:px-4 lg:px-6 py-3 text-right text-xs font-medium"},"จัดการ")])],-1)),t("tbody",St,[(n(!0),i(E,null,N(c.value,s=>(n(),i("tr",{key:s.id},[t("td",Et,[t("div",Nt,[t("div",At,[l.value[s.id]?(n(),i("div",Dt,[p(t("input",{"onUpdate:modelValue":d=>l.value[s.id]=d,onKeyup:[C(d=>w(s),["enter"]),C(d=>_(s.id),["esc"])],"data-key-id":s.id,class:"flex-1 px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",autofocus:""},null,40,Pt),[[b,l.value[s.id]]]),t("button",{onClick:d=>w(s),class:"px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 transition-colors"}," บันทึก ",8,Ut),t("button",{onClick:d=>_(s.id),class:"px-2 py-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded text-xs hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors"}," ยกเลิก ",8,Kt)])):(n(),i("div",Tt,r(s.name),1))]),l.value[s.id]?S("",!0):(n(),i("button",{key:0,onClick:d=>D(s),class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors flex-shrink-0",title:"แก้ไขชื่อ"},[...e[15]||(e[15]=[t("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})],-1)])],8,Lt))]),t("div",Bt,r(s.key_value?.slice(0,8))+"…",1)]),t("td",Mt,[t("div",jt,r(s.fullname),1),t("div",It,r(s.email),1)]),t("td",Ht,r(s.faculty||"-"),1),t("td",Ot,[t("div",Rt,[p(t("input",{type:"number",min:"0",step:"0.01","onUpdate:modelValue":d=>s._credit=d,class:"w-16 md:w-20 lg:w-24 px-1 md:px-2 py-1 border rounded dark:bg-gray-700 dark:text-white text-xs"},null,8,zt),[[b,s._credit,void 0,{number:!0}]]),e[16]||(e[16]=t("span",{class:"text-xs text-gray-500 whitespace-nowrap"},"USD",-1))])]),t("td",Ft,"$"+r(m((s._used??s.current_spend)||0)),1),t("td",qt,[t("button",{onClick:d=>K(s),class:k([s.is_active?"bg-green-100 text-green-800 hover:bg-green-200 dark:bg-green-900 dark:text-green-200":"bg-red-100 text-red-800 hover:bg-red-200 dark:bg-red-900 dark:text-red-200","px-2 py-1 rounded text-xs font-semibold whitespace-nowrap"])},r(s.is_active?"Active":"Disabled"),11,Gt)]),t("td",Jt,[t("div",Qt,[t("button",{onClick:d=>P(s),class:"px-2 md:px-3 py-1 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white rounded text-gray-900 whitespace-nowrap text-xs"},"รายละเอียด",8,Wt),t("button",{onClick:d=>T(s),class:"px-2 md:px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 whitespace-nowrap text-xs"},"บันทึก",8,Xt),t("button",{onClick:d=>U(s),class:"px-2 md:px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 whitespace-nowrap text-xs"},"ลบ",8,Yt)])])]))),128))])])])]),h.value?(n(),i("div",Zt,[t("div",te,[t("div",ee,[e[18]||(e[18]=t("h3",{class:"text-lg font-semibold"},"รายละเอียดคีย์",-1)),t("button",{onClick:e[2]||(e[2]=s=>h.value=!1),class:"text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-200"},"✕")]),t("div",se,[t("div",null,[e[19]||(e[19]=t("span",{class:"font-medium"},"ชื่อ:",-1)),y(" "+r(o.value?.name),1)]),t("div",null,[e[20]||(e[20]=t("span",{class:"font-medium"},"ผู้ใช้:",-1)),y(" "+r(o.value?.fullname)+" ("+r(o.value?.email)+")",1)]),t("div",null,[e[21]||(e[21]=t("span",{class:"font-medium"},"คณะ/หน่วยงาน:",-1)),y(" "+r(o.value?.faculty||"-"),1)]),t("div",null,[e[22]||(e[22]=t("span",{class:"font-medium"},"สถานะ:",-1)),e[23]||(e[23]=y()),t("span",{class:k(o.value?.is_active?"text-green-600":"text-red-600")},r(o.value?.is_active?"เปิดใช้งาน":"ปิดใช้งาน"),3)]),t("div",ae,[e[24]||(e[24]=t("span",{class:"font-medium"},"คีย์:",-1)),e[25]||(e[25]=y()),t("code",de,r(o.value?.key_value),1)]),t("div",re,[t("div",oe,[e[26]||(e[26]=t("span",{class:"font-medium"},"การใช้งาน",-1)),t("span",ie,"$"+r(m(o.value?._used??o.value?.current_spend))+" / $"+r(m(o.value?._credit||o.value?.credit_limit||0)),1)]),t("div",ne,[t("div",{class:k([[A.value>=100||(o.value?._credit||o.value?.credit_limit||0)<=0&&(o.value?._used??o.value?.current_spend)>0?"bg-red-600":"bg-indigo-600"],"h-2 rounded transition-colors"]),style:z({width:Math.min(100,A.value)+"%"})},null,6)])]),t("div",le,[t("div",null,[e[27]||(e[27]=t("div",{class:"text-xs text-gray-500 dark:text-gray-400"},"Limit",-1)),t("div",ue,"$"+r(m(o.value?._credit||o.value?.credit_limit)),1)]),t("div",null,[e[28]||(e[28]=t("div",{class:"text-xs text-gray-500 dark:text-gray-400"},"Used",-1)),t("div",ce,"$"+r(m(o.value?._used??o.value?.current_spend)),1)])])]),t("div",xe,[t("button",{onClick:e[3]||(e[3]=s=>h.value=!1),class:"px-3 py-2 bg-gray-100 dark:bg-neutral-700 hover:bg-gray-200 dark:hover:bg-neutral-600 rounded"},"ปิด")])])])):S("",!0)])])}}});export{pe as default};
